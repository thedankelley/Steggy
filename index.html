<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steggy 1.4 ã‚¹ãƒ†ã‚®ãƒ¼</title>

<meta name="description" content="Client side steganography for private communication">
<meta name="theme-color" content="#3fa46a">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Steggy">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<link rel="manifest" href="./manifest.json">

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js", { scope: "./" });
  });
}
</script>

<style>
:root {
  --bg:#f5f6f7;
  --fg:#111;
  --card:#fff;
  --accent:#3fa46a;
}

body.dark {
  --bg:#121212;
  --fg:#eaeaea;
  --card:#1e1e1e;
}

body {
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,sans-serif;
}

header {
  background:var(--accent);
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header .title {
  display:flex;
  gap:10px;
  align-items:center;
  font-weight:600;
}

header img {
  width:32px;
  height:32px;
  image-rendering:pixelated;
}

button {
  background:var(--accent);
  color:white;
  border:none;
  padding:10px;
  border-radius:6px;
  cursor:pointer;
}

button.secondary {
  background:#666;
}

main {
  max-width:900px;
  margin:auto;
  padding:16px;
}

.card {
  background:var(--card);
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
}

label {
  display:block;
  margin-top:10px;
}

input,textarea,select {
  width:100%;
  padding:8px;
  margin-top:6px;
}

textarea {
  resize:vertical;
}

.preview {
  max-width:100%;
  margin-top:10px;
}

footer {
  text-align:center;
  font-size:13px;
  opacity:0.8;
  padding:20px;
}
</style>
</head>

<body>
<header>
  <div class="title">
    <img id="icon">
    <span>Steggy 1.4 ã‚¹ãƒ†ã‚®ãƒ¼</span>
  </div>
  <button id="themeToggle">ðŸŒ™</button>
</header>

<main>
<div class="card">
  <label>Mode</label>
  <select id="mode">
    <option value="encrypt">Encrypt</option>
    <option value="decrypt">Decrypt</option>
  </select>

  <label>Carrier PNG image</label>
  <input type="file" id="imageInput" accept="image/png">

  <label>Payload text</label>
  <textarea id="payloadText"></textarea>

  <label>Payload file (optional)</label>
  <input type="file" id="payloadFile">

  <label>Password (optional AES GCM)</label>
  <input type="password" id="password">

  <button id="process">Process</button>

  <a id="download" style="display:none"></a>
  <img id="preview" class="preview">
</div>
</main>

<footer>
Created by Dan<br>
Runs fully client side. No data leaves your device.
</footer>

<script>
const ICON="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nGNgGAVxQFhYWJj8z8DAwMgABYwYGEZgEAwC4gqIBZBgAEANn4DgCd4XyAAAAAElFTkSuQmCC";
document.getElementById("icon").src="data:image/png;base64,"+ICON;

const themeBtn=document.getElementById("themeToggle");
if(localStorage.theme==="dark"){
  document.body.classList.add("dark");
  themeBtn.textContent="â˜€ï¸";
}
themeBtn.onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  localStorage.theme=dark?"dark":"light";
  themeBtn.textContent=dark?"â˜€ï¸":"ðŸŒ™";
};

function bytesToBits(bytes){
  return bytes.flatMap(b=>[7,6,5,4,3,2,1,0].map(i=>(b>>i)&1));
}

function bitsToBytes(bits){
  const out=[];
  for(let i=0;i<bits.length;i+=8){
    let b=0;
    for(let j=0;j<8;j++) b=(b<<1)|(bits[i+j]||0);
    out.push(b);
  }
  return new Uint8Array(out);
}

async function encryptAES(data,password){
  if(!password) return data;
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey(
    "raw",
    await crypto.subtle.digest("SHA-256",enc.encode(password)),
    "AES-GCM",
    false,
    ["encrypt"]
  );
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=new Uint8Array(await crypto.subtle.encrypt(
    {name:"AES-GCM",iv},
    key,
    data
  ));
  return new Uint8Array([...iv,...ct]);
}

async function decryptAES(data,password){
  if(!password) return data;
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey(
    "raw",
    await crypto.subtle.digest("SHA-256",enc.encode(password)),
    "AES-GCM",
    false,
    ["decrypt"]
  );
  const iv=data.slice(0,12);
  const ct=data.slice(12);
  return new Uint8Array(await crypto.subtle.decrypt(
    {name:"AES-GCM",iv},
    key,
    ct
  ));
}

document.getElementById("process").onclick=async()=>{
  const mode=document.getElementById("mode").value;
  const imgFile=document.getElementById("imageInput").files[0];
  if(!imgFile){alert("Select an image");return;}

  const img=new Image();
  img.src=URL.createObjectURL(imgFile);
  await img.decode();

  const canvas=document.createElement("canvas");
  canvas.width=img.width;
  canvas.height=img.height;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(img,0,0);
  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);

  if(mode==="encrypt"){
    let payload;
    const file=document.getElementById("payloadFile").files[0];
    payload=file ? new Uint8Array(await file.arrayBuffer())
                 : new TextEncoder().encode(document.getElementById("payloadText").value);

    payload=await encryptAES(payload,document.getElementById("password").value);
    const framed=new Uint8Array([...new TextEncoder().encode("STEGGY14"),...payload]);
    const bits=bytesToBits([...framed]);

    let bitIndex=0;
    for(let i=0;i<imgData.data.length && bitIndex<bits.length;i+=4){
      imgData.data[i]=(imgData.data[i]&254)|bits[bitIndex++];
    }

    ctx.putImageData(imgData,0,0);
    canvas.toBlob(b=>{
      const url=URL.createObjectURL(b);
      document.getElementById("preview").src=url;
      const dl=document.getElementById("download");
      dl.href=url;
      dl.download="steggy.png";
      dl.textContent="Download Image";
      dl.style.display="inline-block";
    });

  } else {
    const bits=[];
    for(let i=0;i<imgData.data.length;i+=4){
      bits.push(imgData.data[i]&1);
    }
    const bytes=bitsToBytes(bits);
    const sig=new TextDecoder().decode(bytes.slice(0,8));
    if(sig!=="STEGGY14"){alert("No Steggy payload found");return;}

    let payload=bytes.slice(8);
    payload=await decryptAES(payload,document.getElementById("password").value);

    try {
      const text=new TextDecoder().decode(payload);
      document.getElementById("payloadText").value=text.replace(/\0/g,"");
    } catch {
      const blob=new Blob([payload]);
      document.getElementById("preview").src=URL.createObjectURL(blob);
    }
  }
};
</script>
</body>
</html>
