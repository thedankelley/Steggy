<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steggy 1.4 ã‚¹ãƒ†ã‚®ãƒ¼</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Steggy">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<script src="https://unpkg.com/openpgp@5.11.0/dist/openpgp.min.js"></script>

<style>
:root {
  --bg-light:#f5f6f7;
  --bg-dark:#121212;
  --card-light:#ffffff;
  --card-dark:#1e1e1e;
  --text-light:#111111;
  --text-dark:#eaeaea;
  --accent:#3fa46a;
  --warn:#c87a2b;
}

body {
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg-light);
  color:var(--text-light);
}

body.dark {
  background:var(--bg-dark);
  color:var(--text-dark);
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  background:var(--accent);
  color:white;
}

header .title {
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:600;
}

header img {
  width:32px;
  height:32px;
  image-rendering:pixelated;
}

button {
  padding:10px;
  border:none;
  border-radius:6px;
  background:var(--accent);
  color:white;
  cursor:pointer;
}

button.secondary {
  background:#666;
}

main {
  max-width:980px;
  margin:auto;
  padding:16px;
}

.card {
  background:var(--card-light);
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
}

body.dark .card {
  background:var(--card-dark);
}

label {
  display:block;
  margin-top:10px;
  font-weight:500;
}

input,textarea,select {
  width:100%;
  margin-top:6px;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}

textarea {
  resize:vertical;
}

#advanced {
  display:none;
  border-left:4px solid var(--warn);
}

.warning {
  background:#fff2dd;
  padding:10px;
  border-radius:6px;
  font-size:14px;
}

body.dark .warning {
  background:#2a1f14;
}

.preview {
  max-width:100%;
  margin-top:10px;
  border-radius:6px;
}

footer {
  text-align:center;
  font-size:13px;
  opacity:0.8;
  padding:20px;
}
</style>
</head>

<body>
<header>
  <div class="title">
    <img id="icon">
    <div>Steggy 1.4 ã‚¹ãƒ†ã‚®ãƒ¼</div>
  </div>
  <button id="themeToggle">ðŸŒ™</button>
</header>

<main>

<div class="card">
  <label>Mode</label>
  <select id="mode">
    <option value="encrypt">Encrypt</option>
    <option value="decrypt">Decrypt</option>
  </select>

  <label>Algorithm</label>
  <select id="algo">
    <option value="auto">Auto detect</option>
    <option value="lsb">LSB scatter</option>
    <option value="pngtext">PNG tEXt chunk</option>
  </select>

  <label>Carrier image (PNG)</label>
  <input type="file" id="imageInput" accept="image/png">

  <label>Payload text</label>
  <textarea id="payloadText"></textarea>

  <label>Payload file (optional)</label>
  <input type="file" id="payloadFile">

  <div id="capacity"></div>

  <button id="advancedToggle" class="secondary">Advanced Settings</button>
</div>

<div class="card" id="advanced">
  <div class="warning">
    Advanced features are intended for experienced users.
    Misuse can permanently destroy access to embedded data.
  </div>

  <label>AES GCM password (optional)</label>
  <input type="password" id="password">

  <label>PGP public key</label>
  <textarea id="pgpPublic"></textarea>

  <label>PGP private key</label>
  <textarea id="pgpPrivate"></textarea>
</div>

<div class="card">
  <button id="process">Process</button>
  <a id="download" style="display:none"></a>
  <img id="imagePreview" class="preview">
</div>

</main>

<footer>
  Created by Dan<br>
  Steggy operates fully offline. No data leaves your device.
</footer>

<script>
const ICON="iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAANklEQVR4nGNgGAVxQFhYWJj8z8DAwMgABYwYGEZgEAwC4gqIBZBgAEANn4DgCd4XyAAAAAElFTkSuQmCC";
document.getElementById("icon").src="data:image/png;base64,"+ICON;

const themeBtn=document.getElementById("themeToggle");
if(localStorage.theme==="dark"){document.body.classList.add("dark");themeBtn.textContent="â˜€ï¸";}
themeBtn.onclick=()=>{
  document.body.classList.toggle("dark");
  const d=document.body.classList.contains("dark");
  localStorage.theme=d?"dark":"light";
  themeBtn.textContent=d?"â˜€ï¸":"ðŸŒ™";
};

document.getElementById("advancedToggle").onclick=()=>{
  const a=document.getElementById("advanced");
  a.style.display=a.style.display==="block"?"none":"block";
};

async function sha256(data){
  const h=await crypto.subtle.digest("SHA-256",data);
  return new Uint8Array(h);
}

function randomIndices(max,count){
  const idx=[];
  const used=new Set();
  while(idx.length<count){
    const r=Math.floor(Math.random()*max);
    if(!used.has(r)){used.add(r);idx.push(r);}
  }
  return idx;
}

function embedLSBScatter(img,payload){
  const pixels=Math.floor(img.data.length/4);
  const bits=payload.length*8;
  const idx=randomIndices(pixels,bits);
  let bit=0;
  for(const i of idx){
    const b=(payload[Math.floor(bit/8)]>>(7-(bit%8)))&1;
    img.data[i*4]=(img.data[i*4]&254)|b;
    bit++;
  }
}

function extractLSBSequential(img,count){
  const out=new Uint8Array(count);
  let bit=0;
  for(let i=0;i<img.data.length && bit<count*8;i+=4){
    out[Math.floor(bit/8)]|=(img.data[i]&1)<<(7-(bit%8));
    bit++;
  }
  return out;
}

document.getElementById("process").onclick=async()=>{
  const mode=document.getElementById("mode").value;
  const imgFile=document.getElementById("imageInput").files[0];
  if(!imgFile){alert("Select a PNG image");return;}

  const img=new Image();
  img.src=URL.createObjectURL(imgFile);
  img.onload=async()=>{
    const c=document.createElement("canvas");
    c.width=img.width;c.height=img.height;
    const ctx=c.getContext("2d");
    ctx.drawImage(img,0,0);
    const data=ctx.getImageData(0,0,c.width,c.height);

    if(mode==="encrypt"){
      let payload;
      const file=document.getElementById("payloadFile").files[0];
      payload=file ? new Uint8Array(await file.arrayBuffer())
                   : new TextEncoder().encode(document.getElementById("payloadText").value);

      const hash=await sha256(payload);
      const framed=new Uint8Array([...new TextEncoder().encode("STEGGY14"),...hash,...payload]);

      embedLSBScatter(data,framed);
      ctx.putImageData(data,0,0);

      c.toBlob(b=>{
        const url=URL.createObjectURL(b);
        document.getElementById("imagePreview").src=url;
        const dl=document.getElementById("download");
        dl.href=url;
        dl.download="steggy.png";
        dl.textContent="Download Image";
        dl.style.display="inline-block";
      });
    } else {
      const raw=extractLSBSequential(data,1024*512);
      const sig=new TextDecoder().decode(raw.slice(0,8));
      if(sig!=="STEGGY14"){alert("No Steggy payload found");return;}
      const body=raw.slice(40);
      document.getElementById("payloadText").value=new TextDecoder().decode(body).replace(/\0/g,"");
    }
  };
};
</script>
</body>
</html>
